<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„É©„É≥„ÉÄ„É†„Ç´„É©„Éº - Palette Generator Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family:'Plus Jakarta Sans',-apple-system,sans-serif;
      margin:0;
      padding:40px 20px;
      background:linear-gradient(135deg, #f8fafb 0%, #f0f4ff 100%);
      color:#222;
      transition:all 0.4s;
    }
    html.dark body {
      background: linear-gradient(180deg, #0a0a15 0%, #141420 100%);
      color: #eaeaea;
    }
    .container {
      max-width:1200px;
      margin:0 auto;
    }
    h1 {
      font-family:'Syne',sans-serif;
      font-size:2.5rem;
      margin:0 0 16px;
      font-weight:800;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .controls {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:20px;
      padding:32px 24px;
      background:rgba(255,255,255,0.95);
      border:1.5px solid rgba(102,126,234,0.15);
      border-radius:16px;
      margin-bottom:32px;
      box-shadow:0 8px 24px rgba(102,126,234,0.1);
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    html.dark .controls {
      background:rgba(22,22,32,0.95);
      border-color:rgba(102,126,234,0.2);
      box-shadow:0 8px 24px rgba(102,126,234,0.08);
    }
    .controls label {
      font-size:0.85rem;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .controls select {
      padding:12px 14px;
      font-size:0.9rem;
      border-radius:10px;
      border:2px solid rgba(102,126,234,0.2);
      background:rgba(255,255,255,0.95);
      cursor:pointer;
      transition:all 0.2s;
      font-family:'Plus Jakarta Sans',sans-serif;
    }
    html.dark .controls select {
      background:rgba(22,22,32,0.9);
      border-color:rgba(102,126,234,0.25);
      color:#f3f4f6;
    }
    .controls select:hover {
      border-color:rgba(102,126,234,0.4);
      box-shadow:0 0 0 3px rgba(102,126,234,0.08);
    }
    .controls select:focus {
      outline:none;
      border-color:#667eea;
      box-shadow:0 0 0 4px rgba(102,126,234,0.15);
    }
    .controls button {
      padding:12px 20px;
      font-size:0.9rem;
      border-radius:10px;
      border:2px solid #00d4ff;
      background:linear-gradient(135deg,#00d4ff 0%,#0099cc 100%);
      color:#fff;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      font-weight:600;
      font-family:'Plus Jakarta Sans',sans-serif;
      box-shadow:0 4px 12px rgba(0,212,255,0.3);
    }
    .controls button:hover {
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,212,255,0.4);
    }
    .controls button:active {
      transform:translateY(0);
    }
    .palette {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:20px;
      padding:20px 0;
    }
    .swatch {
      position:relative;
      height:140px;
      border-radius:14px;
      cursor:pointer;
      overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,0.12);
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      border:2px solid rgba(102,126,234,0.1);
    }
    html.light .swatch {
      border-color:rgba(102,126,234,0.1);
    }
    html.dark .swatch {
      border-color:rgba(102,126,234,0.15);
    }
    .swatch::before {
      content:'';
      position:absolute;
      top:0;
      left:-100%;
      width:100%;
      height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);
      transition:left 0.5s;
      pointer-events:none;
    }
    .swatch:hover::before {
      left: 100%;
    }
    .swatch:hover {
      transform:translateY(-6px) scale(1.02);
      box-shadow:0 12px 32px rgba(102,126,234,0.25);
      border-color:rgba(102,126,234,0.3);
    }
    @media (max-width: 768px) {
      .controls {
        grid-template-columns: 1fr;
        padding: 24px 20px;
        gap: 16px;
      }

      .form-group {
        margin-right: 0;
      }

      .palette {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 12px;
      }

      .swatch {
        height: 110px;
      }
    }

    @media (max-width: 480px) {
      .controls {
        grid-template-columns: 1fr;
        padding: 16px;
        gap: 12px;
      }

      .controls label {
        font-size: 0.75rem;
      }

      .palette {
        grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
        gap: 8px;
      }

      .swatch {
        height: 85px;
        border-radius: 10px;
      }

      .swatch .code {
        font-size: 0.7rem;
        padding: 4px 6px;
      }

      .swatch .lock {
        font-size: 1rem;
        top: 4px;
        right: 4px;
      }
    }
    .swatch .code {
      position:absolute;
      bottom:8px;
      left:8px;
      background:rgba(0,0,0,0.7);
      color:#fff;
      padding:6px 10px;
      font-size:0.75rem;
      border-radius:6px;
      font-weight:700;
      letter-spacing:0.5px;
      backdrop-filter:blur(4px);
    }
    .swatch .lock {
      position:absolute;
      top:8px;
      right:8px;
      font-size:1.3rem;
      color:rgba(255,255,255,0.9);
      text-shadow:0 0 4px rgba(0,0,0,0.6);
      cursor:pointer;
      filter:drop-shadow(0 0 2px rgba(0,0,0,0.3));
      transition:all 0.2s;
    }
    .swatch .lock:hover {
      transform:scale(1.15);
    }
    .swatch.locked .lock {
      color:#ffeb3b;
      text-shadow:0 0 6px rgba(255,235,59,0.6);
    }
  </style>
</head>
<body>
  <nav id="mainNav"></nav>
  <div id="toast" class="toast"></div>

  <div class="container">
    <h1>üé® „É©„É≥„ÉÄ„É†„Ç´„É©„Éº</h1>
    <div class="history-nav" id="historyNav"></div>

    <div class="controls">
      <label>ÂÄãÊï∞:
        <select id="countSelect">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10" selected>10</option>
        </select>
      </label>
      <div class="form-group" style="max-width:200px;">
        <label for="familySelect">Á≥ªÁµ±</label>
        <select id="familySelect">
          <option value="all" selected>ÂÖ®Á≥ªÁµ±</option>
          <option value="red">Ëµ§Á≥ª</option>
          <option value="orange">Ê©ôÁ≥ª</option>
          <option value="yellow">ÈªÑÁ≥ª</option>
          <option value="green">Á∑ëÁ≥ª</option>
          <option value="blue">ÈùíÁ≥ª</option>
          <option value="purple">Á¥´Á≥ª</option>
        </select>
      </div>
      <div class="form-group" style="max-width:200px;">
        <label for="moodSelect">Èõ∞Âõ≤Ê∞ó</label>
        <select id="moodSelect">
          <option value="normal" selected>Ê®ôÊ∫ñ</option>
          <option value="warm">ÊöñËâ≤</option>
          <option value="cool">ÂØíËâ≤</option>
          <option value="pastel">„Éë„Çπ„ÉÜ„É´</option>
          <option value="vivid">„Éì„Éì„ÉÉ„Éâ</option>
        </select>
      </div>
      <button id="genBtn" class="btn btn-primary">ÁîüÊàê</button>
      <button id="copyBtn" class="btn btn-secondary">üìã „Åæ„Å®„ÇÅ„Å¶„Ç≥„Éî„Éº</button>
      <button id="saveBtn" class="btn btn-secondary">üñºÔ∏è ÁîªÂÉè‰øùÂ≠ò</button>
    </div>

    <div class="palette" id="palette"></div>
  </div>

  <script src="common.js"></script>
  <script>
    let paletteEl = null;
    let countSelect = null;
    let familySelect = null;
    let moodSelect = null;
    let family = 'all';
    let mood = 'normal';

    document.addEventListener('DOMContentLoaded', function() {
      buildNav('random');
      buildHistoryNav('random-color.html');
      applyTheme();
      injectCommonStyles();

      paletteEl = document.getElementById('palette');
      countSelect = document.getElementById('countSelect');
      familySelect = document.getElementById('familySelect');
      moodSelect = document.getElementById('moodSelect');
      const copyBtn = document.getElementById('copyBtn');
      const saveBtn = document.getElementById('saveBtn');

      if (!paletteEl || !countSelect) {
        console.error('DOM elements not found');
        return;
      }

      loadSettings();

      countSelect.addEventListener('change', updatePalette);
      familySelect.addEventListener('change', updatePalette);
      moodSelect.addEventListener('change', updatePalette);

      familySelect.addEventListener('change', () => {
        family = familySelect.value;
      });

      moodSelect.addEventListener('change', () => {
        mood = moodSelect.value;
      });

      document.getElementById('genBtn').addEventListener('click', generateAll);
      copyBtn.addEventListener('click', copyPalette);
      saveBtn.addEventListener('click', savePaletteAsImage);

      updatePalette();

      function randRange(min, max) {
        return min + Math.random() * (max - min);
      }

      function hslToHex(h, s, l) {
        h = (h % 360 + 360) % 360;
        s = Math.max(0, Math.min(100, s));
        l = Math.max(0, Math.min(100, l));
        h /= 360;
        s /= 100;
        l /= 100;

        let r, g, b;
        if (s === 0) {
          r = g = b = l;
        } else {
          const hue2rgb = (p, q, t) => {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1/6) return p + (q - p) * 6 * t;
            if (t < 1/2) return q;
            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
          };
          const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          const p = 2 * l - q;
          r = hue2rgb(p, q, h + 1/3);
          g = hue2rgb(p, q, h);
          b = hue2rgb(p, q, h - 1/3);
        }

        const toHex = v => {
          const hex = Math.round(v * 255).toString(16);
          return hex.length === 1 ? '0' + hex : hex;
        };
        return '#' + toHex(r) + toHex(g) + toHex(b);
      }

      function applyMood(hex, mood) {
        const r = parseInt(hex.slice(1, 3), 16) / 255;
        const g = parseInt(hex.slice(3, 5), 16) / 255;
        const b = parseInt(hex.slice(5, 7), 16) / 255;
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h = 0, l = (max + min) / 2, s = 0;

        if (max !== min) {
          s = l < 0.5 ? (max - min) / (max + min) : (max - min) / (2 - max - min);
          const d = max - min;
          switch (max) {
            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
            case g: h = (b - r) / d + 2; break;
            case b: h = (r - g) / d + 4; break;
          }
          h *= 60;
        }

        if (mood === 'pastel') { s = 50; l = 85; }
        if (mood === 'vivid') { s = 100; l = 50; }
        if (mood === 'warm') { h = randRange(0, 90); s = Math.max(s, 60); }
        if (mood === 'cool') { h = randRange(180, 300); s = Math.max(s, 60); }

        return hslToHex(h, s * 100, l * 100);
      }

      function pickHue(fam) {
        switch (fam) {
          case 'red': return randRange(0, 30);
          case 'orange': return randRange(30, 60);
          case 'yellow': return randRange(60, 90);
          case 'green': return randRange(90, 150);
          case 'blue': return randRange(210, 270);
          case 'purple': return randRange(270, 330);
          default: return randRange(0, 360);
        }
      }

      function createSwatch() {
        const div = document.createElement('div');
        div.className = 'swatch';
        div.dataset.locked = 'false';
        div.style.background = '#f0f0f0';

        const code = document.createElement('div');
        code.className = 'code';
        code.textContent = '#f0f0f0';

        const lock = document.createElement('div');
        lock.className = 'lock';
        lock.textContent = 'üîì';

        lock.addEventListener('click', (e) => {
          e.stopPropagation();
          const isLocked = div.dataset.locked === 'true';
          div.dataset.locked = !isLocked;
          div.classList.toggle('locked');
          lock.textContent = isLocked ? 'üîì' : 'üîí';
        });

        div.appendChild(code);
        div.appendChild(lock);

        div.addEventListener('click', () => {
          if (div.dataset.locked === 'false') {
            generateColor(div);
          }
        });

        return div;
      }

      function generateColor(swatch) {
        const h = pickHue(family);
        const s = randRange(50, 90);
        const l = randRange(45, 85);
        let hex = hslToHex(h, s, l);
        hex = applyMood(hex, mood);
        swatch.style.background = hex;
        swatch.querySelector('.code').textContent = hex;
      }

      function generateAll() {
        Array.from(paletteEl.children).forEach(sw => {
          if (sw.dataset.locked === 'false') {
            generateColor(sw);
          }
        });
      }

      function updatePalette() {
        const count = parseInt(countSelect.value, 10);
        const currentCount = paletteEl.children.length;

        for (let i = currentCount; i < count; i++) {
          paletteEl.appendChild(createSwatch());
        }

        while (paletteEl.children.length > count) {
          paletteEl.removeChild(paletteEl.lastChild);
        }

        generateAll();
        saveSettings();
      }

      function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('randomColorSettings') || '{}');
        if (settings.count) countSelect.value = settings.count;
        if (settings.family) familySelect.value = settings.family;
        if (settings.mood) moodSelect.value = settings.mood;
        family = familySelect.value;
        mood = moodSelect.value;
      }

      function saveSettings() {
        const settings = {
          count: countSelect.value,
          family: familySelect.value,
          mood: moodSelect.value
        };
        localStorage.setItem('randomColorSettings', JSON.stringify(settings));
      }

      function copyPalette() {
        const codes = Array.from(paletteEl.children).map(sw => sw.querySelector('.code').textContent).join(' ');
        copyTextToClipboard(codes, {
          successMessage: 'üìã „Éë„É¨„ÉÉ„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü',
          emptyMessage: '‚ö†Ô∏è ÂÖà„Å´„Ç´„É©„Éº„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
          fallbackMessage: '‚ÑπÔ∏è „Ç≥„Éî„Éº‰∏çÂèØ„ÅÆÁí∞Â¢É„Åß„Åô„ÄÇ„Ç´„É©„Éº„Ç≥„Éº„Éâ„ÇíÊâãÂãï„Åß„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
        });
      }

      function savePaletteAsImage() {
        const swatches = Array.from(paletteEl.children);
        if (swatches.length === 0) return;
        const cols = Math.min(5, swatches.length);
        const rows = Math.ceil(swatches.length / cols);
        const size = 120;
        const canvas = document.createElement('canvas');
        canvas.width = cols * size;
        canvas.height = rows * size;
        const ctx = canvas.getContext('2d');
        swatches.forEach((sw, i) => {
          const hex = sw.querySelector('.code').textContent;
          const x = (i % cols) * size;
          const y = Math.floor(i / cols) * size;
          ctx.fillStyle = hex;
          ctx.fillRect(x, y, size, size);
        });
        const link = document.createElement('a');
        link.download = 'palette.png';
        link.href = canvas.toDataURL();
        link.click();
      }

    });
  </script>
</body>
</html>
